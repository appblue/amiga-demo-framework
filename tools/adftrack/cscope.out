cscope 15 $HOME/_amiga_/_work_/amiga-demo-framework/tools/adftrack               0000004650
	@adftrack.c

1 
	~<¡dio.h
>

2 
	~<¡ršg.h
>

4 
	~<veùÜ
>

5 
	~<io¡»am
>

7 
	#ULONG_MAX_32
 0xffffffff

	)

9 
usšg
 
Çme¥aû
 
	g¡d
;

12 
	sFeEÁry
 {

13 * 
	mf’ame
;

14 
	m¡¬toff£t
;

15 
	m¡¬tblock
;

16 
	mnumblocks
;

18 
FeEÁry
() {

19 
	mf’ame
=0;

20 
	m¡¬toff£t
=-1;

21 
	m¡¬tblock
=-1;

22 
	mnumblocks
=0;

25 
FeEÁry
Ğ* 
f’ame
 ) {

26 
	mthis
->
	mf’ame
=
f’ame
;

27 
	mthis
->
	m¡¬toff£t
=-1;

28 
	mthis
->
	m¡¬tblock
=-1;

29 
	mthis
->
	mnumblocks
=0;

34 
ušt32_t
 
	$BSw­IÁ
Ğ
ušt32_t
 
v®ue
 ) {

35 
ušt32_t
 
v®ue2
=(
v®ue
<<24) | ((value & 0xff00)<<8) | ((value & 0xff0000)>>8) | (value>>24);

37  
v®ue2
;

38 
	}
}

41 
	$BSw­IÁA¼ay
Ğ* 
v®ues
, 
size
 ) {

42 
i
=0 ; i<
size
 ; i++) {

43 
v®ues
[
i
]=
	`BSw­IÁ
(values[i]);

45 
	}
}

48 
	$P©chBoÙBlockCheckSum
Ğ* 
buf
 ) {

49 
i
;

50 
ušt32_t
 
Ãwsum
, 
d
;

52 
ušt32_t
* 
buf2
=(ušt32_t*)(
buf
);

54 
buf2
[1]=0;

56 
Ãwsum
=0;

58 
i
=0 ; i<256 ; i++) {

59 
d
=
	`BSw­IÁ
(
buf2
[
i
]);

60 iàĞ(
ULONG_MAX_32
-
Ãwsum
è< 
d
 )

61 
Ãwsum
++;

63 
Ãwsum
+=
d
;

66 
Ãwsum
=~newsum;

68 
buf2
[1]=
	`BSw­IÁ
(
Ãwsum
);

69 
	}
}

72 
	$AddFe
Ğ
FeEÁry
& 
f“Áry
, * 
buf
, & 
feoff£t
 ) {

73 * 
f’ame
=
f“Áry
.filename;

75 
cout
 << "addšg fe: " << 
f’ame
 << 
’dl
;

78 
FILE
* 
f”
=
	`fİ’
(
f’ame
, "rb");

79 if(!
f”
) {

80 
	`´štf
("ÿÂÙ o³À\"%s\"\n", 
f’ame
);

81 
	`ex™
(-1);

85 
	`f£ek
(
f”
, 0, 
SEEK_END
);

86 
fesize
=
	`á–l
(
f”
);

87 
	`f£ek
(
f”
, 0, 
SEEK_SET
);

89 if(
fesize
<=0) {

90 
	`´štf
("f\"%s\" i em±y\n", 
f’ame
);

91 
	`ex™
(-1);

94 
fesize_·dded_to_blocks
 = 512*((
fesize
/512)+1);

100 
f“ndoff£t
=
feoff£t
+
fesize_·dded_to_blocks
;

101 
ä“¥aû
=901120-
f“ndoff£t
;

102 ià(
ä“¥aû
<0) {

103 
	`´štf
("couldÁ fšd s·û fÜ f\"%s\" - disk fuÎ!\n", 
f’ame
);

104 
	`ex™
(-1);

108 * 
buf2
=
Ãw
 [
fesize_·dded_to_blocks
];

109 
	`mem£t
(
buf2
, 0, 
fesize_·dded_to_blocks
);

111 
	`ä—d
(
buf2
, 1, 
fesize
, 
f”
);

114 
	`memıy
(
buf
+
feoff£t
, 
buf2
, 
fesize_·dded_to_blocks
);

116 
cout
 << "ä“ s·û: " << 
ä“¥aû
 << 
’dl
;

119 
¡¬tblock
=
feoff£t
/512;

120 
’dblock
=(
f“ndoff£t
-1)/512;

121 
numblocks
=(
’dblock
-
¡¬tblock
)+1;

124 
f“Áry
.
¡¬toff£t
=
feoff£t
;

125 
f“Áry
.
¡¬tblock
=
feoff£t
/512;

126 
f“Áry
.
numblocks
=numblocks;

129 
d–‘e
 [] 
buf2
;

131 
	`fşo£
(
f”
);

134 
feoff£t
=
f“ndoff£t
;

135 
	}
}

140 
	$maš
(
¬gc
, **
¬gv
) {

142 if(
¬gc
 < 3) {

143 
	`´štf
("u§g% <boÙblock> <outfe> <m­fe> [À<f’ames>]\n", 
¬gv
[0]);

144 
	`ex™
(-1);

148 cÚ¡ * 
boÙÇme
=
¬gv
[1];

149 cÚ¡ * 
fewÇme
=
¬gv
[2];

150 cÚ¡ * 
m­Çme
=
¬gv
[3];

153 
FILE
* 
boÙfe
=
	`fİ’
(
boÙÇme
, "rb");

154 if(!
boÙfe
) {

155 
	`´štf
("ÿÂÙ o³À\"%s\"\n", 
boÙÇme
);

156 
	`ex™
(-1);

160 
	`f£ek
(
boÙfe
, 0, 
SEEK_END
);

161 
boÙsize
=
	`á–l
(
boÙfe
);

162 
	`f£ek
(
boÙfe
, 0, 
SEEK_SET
);

163 ià(
boÙsize
>1024) {

164 
	`´štf
("\"%s\" ha wrÚg fesize.‡ v®id boÙblock mu¡ b<ğ1024 by‹s.\n", 
boÙÇme
);

165 
	`ex™
(-1);

169 
fesize
=901120;

171 * 
buf
=
Ãw
 [
fesize
];

173 
	`mem£t
(
buf
, 0, 
fesize
);

176 
	`ä—d
(
buf
, 1, 
boÙsize
, 
boÙfe
);

179 
	`P©chBoÙBlockCheckSum
(
buf
);

182 
veùÜ
<
FeEÁry
> 
fes
;

184 
numfes
 = 
¬gc
 - 4;

186 
i
=0 ; i<
numfes
 ; i++) {

187 
fes
.
	`push_back
((*)
¬gv
[ 
i
 + 4 ]);

191 
feoff£t
=3*512;

194 
i
=0 ; i<
numfes
 ; i++) {

195 
	`AddFe
(
fes
[
i
], 
buf
, 
feoff£t
);

201 
mydœ£ùÜ
[128];

203 
	`mem£t
(
mydœ£ùÜ
, 0, (mydirsector));

205 * 
mydœpoi
=
mydœ£ùÜ
;

208 
FILE
* 
m­fe
=
	`fİ’
(
m­Çme
, "w+");

209 if(!
m­fe
) {

210 
	`´štf
("ÿÂÙ o³À\"%s\"\n", 
m­Çme
);

211 
	`ex™
(-1);

214 
i
=0 ; i<
numfes
 ; i++) {

215 *
mydœpoi
++=(
fes
[
i
].
¡¬tblock
);

216 *
mydœpoi
++=
fes
[
i
].
numblocks
;

217 
	`årštf
(
m­fe
, "%s_sblock = %d\n", 
fes
[
i
].
f’ame
, fes[i].
¡¬tblock
);

218 
	`årštf
(
m­fe
, "%s_nblock = %d\n", 
fes
[
i
].
f’ame
, fes[i].
numblocks
);

220 
	`´štf
("%s_sblock = %d\n", 
fes
[
i
].
f’ame
, fes[i].
¡¬tblock
);

221 
	`´štf
("%s_nblock = %d\n", 
fes
[
i
].
f’ame
, fes[i].
numblocks
);

224 
	`fşo£
(
m­fe
);

227 
	`BSw­IÁA¼ay
((*)(
mydœ£ùÜ
), 128);

230 
	`memıy
(
buf
+2*512, 
mydœ£ùÜ
, (mydirsector));

233 
FILE
* 
few
=
	`fİ’
(
fewÇme
, "wb");

234 if(!
few
) {

235 
	`´štf
("ÿÂÙ o³À\"%s\"\n", 
fewÇme
);

236 
	`ex™
(-1);

239 
	`fwr™e
(
buf
, 1, 
fesize
, 
few
);

242 
d–‘e
 [] 
buf
;

244 
	`fşo£
(
boÙfe
);

245 
	`fşo£
(
few
);

246 
	}
}

	@
1
.
0
1
11
adftrack.c
